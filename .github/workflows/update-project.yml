name: update-project

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]

jobs:
  update-project:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v3

      - name: Set variables
        run: |
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "REPO_OWNER=virusneo1997-del" >> $GITHUB_ENV
          echo "REPO_NAME=college-linux-course" >> $GITHUB_ENV
          echo "PROJECT_NAME=Автоматизация курсов" >> $GITHUB_ENV

      - name: Install GitHub CLI
        run: sudo apt-get install -y gh

      - name: Auth GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: gh auth setup-git

      - name: Find Project ID
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          PROJECT_ID=$(gh api graphql -f query='
            query {
              viewer {
                projectsV2(first: 20) {
                  nodes {
                    id
                    title
                  }
                }
              }
            }' --jq ".data.viewer.projectsV2.nodes[] | select(.title==\"$PROJECT_NAME\") | .id")

          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV

      - name: Add PR to Project v2 (if missing)
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          ITEM_ID=$(gh api graphql -f query='
            query($proj:ID!, $pr:Int!) {
              node(id: $proj) {
                ... on ProjectV2 {
                  items(first:100) {
                    nodes {
                      content {
                        ... on PullRequest { number }
                      }
                      id
                    }
                  }
                }
              }
            }' -f proj=$PROJECT_ID -f pr=$PR_NUMBER --jq ".data.node.items.nodes[] | select(.content.number==$PR_NUMBER) | .id")

          if [ -z "$ITEM_ID" ]; then
            ITEM_ID=$(gh api graphql -f query='
              mutation($project:ID!, $pr:ID!) {
                addProjectV2ItemById(input:{projectId:$project, contentId:$pr}) {
                  item { id }
                }
              }' \
              -f project=$PROJECT_ID \
              -f pr="PR_${PR_NUMBER}" \
              --jq ".data.addProjectV2ItemById.item.id")
          fi

          echo "ITEM_ID=$ITEM_ID" >> $GITHUB_ENV

      - name: Get column IDs
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          gh api graphql -f query='
            query($id:ID!) {
              node(id: $id) {
                ... on ProjectV2 {
                  fields(first:20) {
                    nodes { id name }
                  }
                }
              }
            }
          ' -f id=$PROJECT_ID > fields.json

          STATUS_FIELD_ID=$(jq -r '.data.node.fields.nodes[] | select(.name=="Status") | .id' fields.json)

          echo "STATUS_FIELD_ID=$STATUS_FIELD_ID" >> $GITHUB_ENV

      - name: Determine new status
        run: |
          if [[ "${{ github.event.action }}" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
            echo "TARGET_STATUS=Done" >> $GITHUB_ENV
          elif [[ "${{ github.event.action }}" == "closed" ]]; then
            echo "TARGET_STATUS=To do" >> $GITHUB_ENV
          elif [[ ! -z "${{ github.event.pull_request.requested_reviewers }}" ]]; then
            echo "TARGET_STATUS=In review" >> $GITHUB_ENV
          else
            echo "TARGET_STATUS=In Progress" >> $GITHUB_ENV
          fi

      - name: Update status in Project v2
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          gh api graphql -f query='
            mutation($project:ID!, $item:ID!, $field:ID!, $value:String!) {
              updateProjectV2ItemFieldValue(input:{
                projectId:$project,
                itemId:$item,
                fieldId:$field,
                value:{ singleSelectOptionId:$value }
              }) {
                projectV2Item { id }
              }
            }
          ' \
          -f project=$PROJECT_ID \
          -f item=$ITEM_ID \
          -f field=$STATUS_FIELD_ID \
          -f value="$TARGET_STATUS"
