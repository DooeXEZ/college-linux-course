name: Update Project v2

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set variables
        run: |
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "PR_NODE_ID=${{ github.event.pull_request.node_id }}" >> $GITHUB_ENV
          echo "OWNER=virusneo1997-del" >> $GITHUB_ENV
          echo "PROJECT_NAME=Автоматизация курсов" >> $GITHUB_ENV

      # ---------- FIND PROJECT ID ----------
      - name: Find Project ID
        id: find_project
        run: |
          QUERY='
          query {
            user(login: "'${OWNER}'") {
              projectsV2(first: 20) {
                nodes {
                  id
                  title
                }
              }
            }
          }'

          RESULT=$(gh api graphql -f query="$QUERY" --jq '.data.user.projectsV2.nodes[] | select(.title=="env.PROJECT_NAME") | .id' \
            -F PROJECT_NAME="${PROJECT_NAME}")
          
          echo "PROJECT_ID=$RESULT" >> $GITHUB_ENV
          echo "FOUND PROJECT: $RESULT"

        env:
          GH_TOKEN: ${{ secrets.PAT }}

      # ---------- ADD PR TO PROJECT IF MISSING ----------
      - name: Add PR to Project v2 (if missing)
        run: |
          gh project item-add $PROJECT_ID --content-id $PR_NODE_ID
        env:
          GH_TOKEN: ${{ secrets.PAT }}

      # ---------- GET COLUMN IDS ----------
      - name: Get column IDs
        id: columns
        run: |
          QUERY='
          query {
            node(id: "'${PROJECT_ID}'") {
              ... on ProjectV2 {
                fields(first: 20) {
                  nodes {
                    id
                    name
                  }
                }
              }
            }
          }'
          echo 'COLS<<EOF' >> $GITHUB_ENV
          gh api graphql -f query="$QUERY" >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.PAT }}

      # ---------- DETERMINE NEW STATUS ----------
      - name: Determine new status
        id: new_status
        run: |
          if [[ "${{ github.event.pull_request.state }}" == "open" ]]; then
            if [[ -n "${{ github.event.pull_request.requested_reviewers }}" ]]; then
              echo "STATUS=In review" >> $GITHUB_ENV
            else
              echo "STATUS=In Progress" >> $GITHUB_ENV
            fi
          elif [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
            echo "STATUS=Done" >> $GITHUB_ENV
          else
            echo "STATUS=To do" >> $GITHUB_ENV
          fi

      # ---------- UPDATE PROJECT ITEM ----------
      - name: Update status in Project v2
        run: |
          FIELD_ID=$(echo "$COLS" | jq -r '.data.node.fields.nodes[] | select(.name=="Status") | .id')

          gh project item-update $PROJECT_ID --item-id $PR_NODE_ID --field-id "$FIELD_ID" --value "$STATUS"
        env:
          GH_TOKEN: ${{ secrets.PAT }}
