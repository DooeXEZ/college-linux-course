name: Check student submission

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-student:
    runs-on: ubuntu-latest

    steps:
      - name: Extract PR info
        id: pr
        run: |
          echo "BRANCH=${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV

      - name: Checkout student's repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ env.BRANCH }}

      - name: Determine lesson folder
        id: lesson
        run: |
          # –∏—â–µ–º –ª—é–±—É—é –ø–∞–ø–∫—É lesson-xx
          folder=$(find . -maxdepth 1 -type d -name "lesson-*")
          if [ -z "$folder" ]; then
            echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–∞–ø–∫–∞ —É—Ä–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: lesson-02)."
            exit 1
          fi
          echo "LESSON=$folder" >> $GITHUB_ENV
          echo "–ù–∞–π–¥–µ–Ω–∞ –ø–∞–ø–∫–∞ —É—Ä–æ–∫–∞: $folder"

      - name: Validate student structure
        run: |
          REPORT="${{ env.LESSON }}/student-report.md"
          if [ ! -f "$REPORT" ]; then
            echo "‚ùå –§–∞–π–ª student-report.md –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."
            exit 1
          fi
          echo "student-report.md –Ω–∞–π–¥–µ–Ω"

      - name: Checkout teacher's course repository
        uses: actions/checkout@v3
        with:
          repository: virusneo1997-del/college-linux-course
          path: course

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r course/requirements.txt

      - name: Run automated tests for this lesson
        run: |
          echo "–ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –¥–ª—è ${{ env.LESSON }}"
          python course/scripts/run_lesson_tests.py HEAD~1 HEAD
        continue-on-error: true
        id: tests

      - name: Add PR comment with test summary
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            ## üß™ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏—è

            **–£—Ä–æ–∫:** `${{ env.LESSON }}`  
            **–°—Ç–∞—Ç—É—Å:** ${{ steps.tests.outcome }}

            –õ–æ–≥–∏ —Ç–µ—Å—Ç–æ–≤:
            ```
            ${{ steps.tests.outputs.test-results }}
            ```

      - name: Fail job if tests failed
        if: steps.tests.outcome != 'success'
        run: |
          echo "‚ùå –¢–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã"
          exit 1

      - name: Success
        run: echo "üéâ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!"
